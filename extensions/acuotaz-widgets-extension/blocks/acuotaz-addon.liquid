{% schema %}
{
  "name": "aCuotaz Product Addon",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Configuración del API"
    },
    {
      "type": "text",
      "id": "client_id",
      "label": "Client ID",
      "info": "Token de autorización para el API"
    },
    {
      "type": "text",
      "id": "api_base_url",
      "label": "URL Base del API",
      "default": "https://apurata.com/pos/pay-with-apurata-add-on",
      "info": "URL base del API para obtener el HTML del addon"
    }
  ]
}
{% endschema %}

{% comment %}
  aCuotaz Addon
  Este bloque funciona como un widget que se puede colocar en cualquier parte de la tienda,
  no se va al header como el headband.
{% endcomment %}

{% assign client_id = block.settings.client_id %}
{% assign api_base_url = block.settings.api_base_url | default: 'https://apurata.com/pos/pay-with-apurata-add-on' %}

{% comment %} Solo renderizar el addon si hay un client_id configurado {% endcomment %}
{% if client_id and client_id != blank %}
<div class="acuotaz-addon-container" id="acuotaz-addon-{{ block.id }}">
  <div class="acuotaz-loading" style="text-align: center; padding: 10px; color: #666; font-size: 14px;">
    <img src="{{ 'thumbs-up.png' | asset_url }}" alt="aCuotaz" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
    Cargando información de aCuotaz...
  </div>
</div>
{% endif %}

{% if client_id and client_id != blank %}
<script>
(function() {
  const container = document.getElementById('acuotaz-addon-{{ block.id }}');
  if (!container) return;

  function getProductPrice() {
    // Usar el precio del producto de Shopify directamente
    {% if product %}
      return {{ product.price | money_without_currency | remove: ',' }};
    {% else %}
      // Fallback: buscar en la página si no hay objeto product
      const priceElements = document.querySelectorAll('.price, .product-price, [class*="price"], [class*="Price"], .money');

      for (const priceElement of priceElements) {
        const priceText = priceElement.textContent || priceElement.innerText;
        if (priceText) {
          // Buscar múltiples formatos de moneda
          const patterns = [
            /S\/\.?\s*(\d+(?:[.,]\d{2})?)/,  // S/. 200.00
            /\$(\d+(?:[.,]\d{2})?)/,         // $200.00
            /€(\d+(?:[.,]\d{2})?)/,          // €200.00
            /(\d+(?:[.,]\d{2})?)\s*PEN/,     // 200.00 PEN
            /(\d+(?:[.,]\d{2})?)\s*USD/      // 200.00 USD
          ];

          for (const pattern of patterns) {
            const match = priceText.match(pattern);
            if (match) {
              const price = parseFloat(match[1].replace(',', '.'));
              if (!isNaN(price) && price > 0) {
                return price;
              }
            }
          }
        }
      }
      return null;
    {% endif %}
  }

  // Load addon content
  function loadAddon() {
    const price = getProductPrice();

    if (!price) {
      container.innerHTML = '<div style="text-align: center; color: #999;">Precio no disponible</div>';
      return;
    }

    container.innerHTML = '<div style="text-align: center; color: #666;">Cargando...</div>';

    fetch('{{ api_base_url }}/' + price + '?page=product', {
      headers: { 'Client_id': '{{ client_id }}' }
    })
    .then(response => response.text())
    .then(html => container.innerHTML = html || 'Sin información disponible')
    .catch(() => container.innerHTML = 'Error al cargar');
  }

  // Load initially
  loadAddon();

  // Reload on variant changes
  document.addEventListener('change', function(e) {
    if (e.target.matches('input[name="id"], select[name="id"]')) {
      setTimeout(loadAddon, 100);
    }
  });
})();
</script>
{% endif %}
