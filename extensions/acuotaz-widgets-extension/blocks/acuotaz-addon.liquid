{% schema %}
{
  "name": "aCuotaz Product Addon",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Configuración del API"
    },
    {
      "type": "text",
      "id": "client_id",
      "label": "Client ID",
      "info": "Token de autorización para el API"
    },
  ]
}
{% endschema %}

{% comment %}
  aCuotaz Addon
  Este bloque funciona como un widget que se puede colocar en cualquier parte de la tienda,
  no se va al header como el headband.
{% endcomment %}

{% assign client_id = block.settings.client_id %}
{% assign api_base_url = 'https://apurata.com/pos/pay-with-apurata-add-on' %}

{% comment %} Solo renderizar el addon si hay un client_id configurado {% endcomment %}
{% if client_id and client_id != blank %}
<div class="acuotaz-addon-container" id="acuotaz-addon-{{ block.id }}">
  <div class="acuotaz-loading" style="text-align: center; padding: 10px; color: #666; font-size: 14px;">
    <img src="{{ 'thumbs-up.png' | asset_url }}" alt="aCuotaz" width="20" height="20" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
    Cargando información de aCuotaz... Espera un momento
  </div>
</div>
{% else %}
<div class="acuotaz-addon-container" style="text-align: center; padding: 10px; color: #666; font-size: 14px; border: 1px solid #e0e0e0; border-radius: 4px; background-color: #f8f8f8;">
  <div>
    <img src="{{ 'thumbs-up.png' | asset_url }}" alt="aCuotaz" width="20" height="20" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
    Configura tu Client ID para ver el addon de aCuotaz
  </div>
</div>
{% endif %}

{% if client_id and client_id != blank %}
<script>
(function() {
  const container = document.getElementById('acuotaz-addon-{{ block.id }}');
  if (!container) return;

  function getProductPrice() {
    // Usar el precio del producto de Shopify directamente
    {% if product %}
      return {{ product.price | money_without_currency | remove: ',' }};
    {% else %}
      // Fallback: buscar en la página si no hay objeto product
      const priceElements = document.querySelectorAll('.price, .product-price, [class*="price"], [class*="Price"], .money');

      for (const priceElement of priceElements) {
        const priceText = priceElement.textContent || priceElement.innerText;
        if (priceText) {
          // Buscar múltiples formatos de moneda
          const patterns = [
            /S\/\.?\s*(\d+(?:[.,]\d{2})?)/,  // S/. 200.00
            /\$(\d+(?:[.,]\d{2})?)/,         // $200.00
            /€(\d+(?:[.,]\d{2})?)/,          // €200.00
            /(\d+(?:[.,]\d{2})?)\s*PEN/,     // 200.00 PEN
            /(\d+(?:[.,]\d{2})?)\s*USD/      // 200.00 USD
          ];

          for (const pattern of patterns) {
            const match = priceText.match(pattern);
            if (match) {
              const price = parseFloat(match[1].replace(',', '.'));
              if (!isNaN(price) && price > 0) {
                return price;
              }
            }
          }
        }
      }
      return null;
    {% endif %}
  }

  // Load addon content
  function loadAddon() {
    const price = getProductPrice();

    if (!price) {
      container.innerHTML = '<div style="text-align: center; color: #999;">Precio no disponible</div>';
      return;
    }

    fetch('{{ api_base_url }}/' + price + '?page=product', {
      headers: { 'Client_id': '{{ client_id }}' }
    })
    .then(response => {
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('TOKEN_INVALID');
        }
        throw new Error('Error en la respuesta del API: ' + response.status);
      }
      return response.text();
    })
    .then(html => {
      container.innerHTML = html || 'Sin información disponible';
    })
    .catch(error => {
      console.error('Error cargando el addon de aCuotaz:', error);
      if (error.message === 'TOKEN_INVALID') {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 14px;">Ingresa un Client ID válido para ver las ofertas de aCuotaz</div>';
      } else {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 14px;">No se pudieron cargar las ofertas en este momento.</div>';
      }
    });
  }

  // Load initially
  loadAddon();

  // Reload on variant changes
  document.addEventListener('change', function(e) {
    if (e.target.matches('input[name="id"], select[name="id"]')) {
      setTimeout(loadAddon, 100);
    }
  });
})();
</script>
{% endif %}
