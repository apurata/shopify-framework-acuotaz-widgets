{% schema %}
{
  "name": "aCuotaz Product Addon",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Configuraci贸n del API"
    },
    {
      "type": "text",
      "id": "client_id",
      "label": "Client ID",
      "info": "Token de autorizaci贸n para el API"
    },
    {
      "type": "text",
      "id": "api_base_url",
      "label": "URL Base del API",
      "default": "https://apurata.com/pos/pay-with-apurata-add-on",
      "info": "URL base del API para obtener el HTML del addon"
    }
  ]
}
{% endschema %}

{% comment %}
  aCuotaz Addon
  Este bloque funciona como un widget que se puede colocar en cualquier parte de la tienda,
  no se va al header como el headband.
{% endcomment %}

{% assign client_id = block.settings.client_id %}
{% assign api_base_url = block.settings.api_base_url | default: 'https://apurata.com/pos/pay-with-apurata-add-on' %}

{% comment %} Solo renderizar el addon si hay un client_id configurado {% endcomment %}
{% if client_id and client_id != blank %}
<div class="acuotaz-addon-container" id="acuotaz-addon-{{ block.id }}">
  <div class="acuotaz-loading" style="text-align: center; padding: 10px; color: #666; font-size: 14px;">
    <img src="{{ 'thumbs-up.png' | asset_url }}" alt="aCuotaz" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
    Cargando informaci贸n de aCuotaz...
  </div>
</div>
{% endif %}

{% if client_id and client_id != blank %}
<script>
(function() {
  const container = document.getElementById('acuotaz-addon-{{ block.id }}');
  if (!container) return;

  function getProductPrice() {
    // Single selector with all price-related elements
    const priceElements = document.querySelectorAll('.price, .product-price, [class*="price"], [class*="Price"], .money');

    // Single loop through all found elements
    for (const priceElement of priceElements) {
      const priceText = priceElement.textContent || priceElement.innerText;
      if (priceText) {
        // Handle Peruvian format: S/. 200.00 PEN
        const peruMatch = priceText.match(/S\/\.?\s*(\d+(?:[.,]\d{2})?)/);
        if (peruMatch) {
          const price = parseFloat(peruMatch[1].replace(',', '.'));
          if (!isNaN(price) && price > 0) {
            return price;
          }
        }
      }
    }
    return null;
  }

  // Load addon content
  function loadAddon() {
    const price = getProductPrice();

    if (!price) {
      container.innerHTML = '<div style="text-align: center; color: #999;">Precio no disponible</div>';
      return;
    }

    container.innerHTML = '<div style="text-align: center; color: #666;">Cargando...</div>';

    fetch('{{ api_base_url }}/' + price + '?page=product', {
      headers: { 'Client_id': '{{ client_id }}' }
    })
    .then(response => response.text())
    .then(html => container.innerHTML = html || 'Sin informaci贸n disponible')
    .catch(() => container.innerHTML = 'Error al cargar');
  }

  // Load initially
  loadAddon();

  // Reload on variant changes
  document.addEventListener('change', function(e) {
    if (e.target.matches('input[name="id"], select[name="id"]')) {
      setTimeout(loadAddon, 100);
    }
  });
})();
</script>
{% endif %}
